name: Jfrog Downlaod


on: workflow_dispatch 


jobs:
 build:
   runs-on: ubuntu-latest
  
   steps:
   # This action checks out the code from the repository
   - name: Checkout Code
     uses: actions/checkout@v2


   # This action sets up the JFrog CLI with the Artifactory URL and access token     
   - uses: jfrog/setup-jfrog-cli@v3
     env:
       JF_URL: "https://venkata14.jfrog.io"
       JF_ACCESS_TOKEN: "eyJ2ZXIiOiIyIiwidHlwIjoiSldUIiwiYWxnIjoiUlMyNTYiLCJraWQiOiJrUzlFVV8zMnZpTWRpb0RsSDYxbG02OXpfU3I2S2NBNHNpaWJxY1h0N1ZnIn0.eyJzdWIiOiJqZmFjQDAxaHJ0anE5Njhxa2g0MDJqZG0zdDIwem10L3VzZXJzL2FkbWluIiwic2NwIjoiYXBwbGllZC1wZXJtaXNzaW9ucy9hZG1pbiIsImF1ZCI6IipAKiIsImlzcyI6ImpmZmVAMDFocnRqcTk2OHFraDQwMmpkbTN0MjB6bXQiLCJpYXQiOjE3MTAzNTI1MjEsImp0aSI6ImIzYTFhNWY4LTAyMjktNGNmZi1hNjBhLTVkYTNmM2ViZjQ1MyJ9.TB9LyeaIg0u-21uqAeZHcNxkV34jQivc5zNWf_uPe1XKQQhtkzlikRzZ_RSlWzMW76_Noh-a2pKF5_-3QafQyhbPO4KbYzJSQiIYZobCtucPIZ9Z2MEpUOcQnelRRXUDL1t7ZpeFMENJ0Xn5x2J0Ng7E9VjUxeixiuc2JbzxknC03z9Eh0n0p4XQ6667fr3Vgf9X5afyyza_HIQ-uTPbItmeIt802QY_JaXEbbUc_t2g01lqik9lLSx7mj3N53DVYh_VZxIkClNe3RpTn_TLcSIxbWjPVJA3DImnQDynzbZ2bIM59gppEczNB9hnPvjHo2M2d0K7M286_1l7IDUVvg"


   # This command adds a new server configuration to the JFrog CLI   
   - run: |
       export SERVER_ID="venkata14"
       jf c add $SERVER_ID --url="https://venkata14.jfrog.io" --access-token="eyJ2ZXIiOiIyIiwidHlwIjoiSldUIiwiYWxnIjoiUlMyNTYiLCJraWQiOiJrUzlFVV8zMnZpTWRpb0RsSDYxbG02OXpfU3I2S2NBNHNpaWJxY1h0N1ZnIn0.eyJzdWIiOiJqZmFjQDAxaHJ0anE5Njhxa2g0MDJqZG0zdDIwem10L3VzZXJzL2FkbWluIiwic2NwIjoiYXBwbGllZC1wZXJtaXNzaW9ucy9hZG1pbiIsImF1ZCI6IipAKiIsImlzcyI6ImpmZmVAMDFocnRqcTk2OHFraDQwMmpkbTN0MjB6bXQiLCJpYXQiOjE3MTAzNTI1MjEsImp0aSI6ImIzYTFhNWY4LTAyMjktNGNmZi1hNjBhLTVkYTNmM2ViZjQ1MyJ9.TB9LyeaIg0u-21uqAeZHcNxkV34jQivc5zNWf_uPe1XKQQhtkzlikRzZ_RSlWzMW76_Noh-a2pKF5_-3QafQyhbPO4KbYzJSQiIYZobCtucPIZ9Z2MEpUOcQnelRRXUDL1t7ZpeFMENJ0Xn5x2J0Ng7E9VjUxeixiuc2JbzxknC03z9Eh0n0p4XQ6667fr3Vgf9X5afyyza_HIQ-uTPbItmeIt802QY_JaXEbbUc_t2g01lqik9lLSx7mj3N53DVYh_VZxIkClNe3RpTn_TLcSIxbWjPVJA3DImnQDynzbZ2bIM59gppEczNB9hnPvjHo2M2d0K7M286_1l7IDUVvg" --interactive=false


   # - name: Run JFrog CLI Ping
   #   run: |
   #        export JFROG_CLI_HOME="/home/runner/work/jenkins-test/jenkins-test"
   #        jf rt u "Jenkinsfile1" "tf-trial/workspaces/jfrog-ws1/"
   #        # Collect environment variables for the build
   #        jf rt bce
   #        # Publish build info
   #        jf rt bp
   # - name: Download Artifact
   #   run: |
   #        jf rt dl tf-trial/workspaces/jfrog-ws1/README.md ./ 
   #        jf rt bp


   - name: Display structure of downloaded files of Artifact 
     run: ls -R
     working-directory: ${{ github.workspace }}

 test:
        name: Test
        needs: build
        runs-on: ubuntu-latest
        steps:
        - name: Checkout Code
          uses: actions/checkout@v2


   # This action sets up the JFrog CLI with the Artifactory URL and access token     
        - uses: jfrog/setup-jfrog-cli@v3
          env:
           JF_URL: "https://venkata14.jfrog.io"
           JF_ACCESS_TOKEN: "eyJ2ZXIiOiIyIiwidHlwIjoiSldUIiwiYWxnIjoiUlMyNTYiLCJraWQiOiJrUzlFVV8zMnZpTWRpb0RsSDYxbG02OXpfU3I2S2NBNHNpaWJxY1h0N1ZnIn0.eyJzdWIiOiJqZmFjQDAxaHJ0anE5Njhxa2g0MDJqZG0zdDIwem10L3VzZXJzL2FkbWluIiwic2NwIjoiYXBwbGllZC1wZXJtaXNzaW9ucy9hZG1pbiIsImF1ZCI6IipAKiIsImlzcyI6ImpmZmVAMDFocnRqcTk2OHFraDQwMmpkbTN0MjB6bXQiLCJpYXQiOjE3MTAzNTI1MjEsImp0aSI6ImIzYTFhNWY4LTAyMjktNGNmZi1hNjBhLTVkYTNmM2ViZjQ1MyJ9.TB9LyeaIg0u-21uqAeZHcNxkV34jQivc5zNWf_uPe1XKQQhtkzlikRzZ_RSlWzMW76_Noh-a2pKF5_-3QafQyhbPO4KbYzJSQiIYZobCtucPIZ9Z2MEpUOcQnelRRXUDL1t7ZpeFMENJ0Xn5x2J0Ng7E9VjUxeixiuc2JbzxknC03z9Eh0n0p4XQ6667fr3Vgf9X5afyyza_HIQ-uTPbItmeIt802QY_JaXEbbUc_t2g01lqik9lLSx7mj3N53DVYh_VZxIkClNe3RpTn_TLcSIxbWjPVJA3DImnQDynzbZ2bIM59gppEczNB9hnPvjHo2M2d0K7M286_1l7IDUVvg"


   # This command adds a new server configuration to the JFrog CLI   
        - run: |
            export SERVER_ID="venkata14"
            jf c add $SERVER_ID --url="https://venkata14.jfrog.io" --access-token="eyJ2ZXIiOiIyIiwidHlwIjoiSldUIiwiYWxnIjoiUlMyNTYiLCJraWQiOiJrUzlFVV8zMnZpTWRpb0RsSDYxbG02OXpfU3I2S2NBNHNpaWJxY1h0N1ZnIn0.eyJzdWIiOiJqZmFjQDAxaHJ0anE5Njhxa2g0MDJqZG0zdDIwem10L3VzZXJzL2FkbWluIiwic2NwIjoiYXBwbGllZC1wZXJtaXNzaW9ucy9hZG1pbiIsImF1ZCI6IipAKiIsImlzcyI6ImpmZmVAMDFocnRqcTk2OHFraDQwMmpkbTN0MjB6bXQiLCJpYXQiOjE3MTAzNTI1MjEsImp0aSI6ImIzYTFhNWY4LTAyMjktNGNmZi1hNjBhLTVkYTNmM2ViZjQ1MyJ9.TB9LyeaIg0u-21uqAeZHcNxkV34jQivc5zNWf_uPe1XKQQhtkzlikRzZ_RSlWzMW76_Noh-a2pKF5_-3QafQyhbPO4KbYzJSQiIYZobCtucPIZ9Z2MEpUOcQnelRRXUDL1t7ZpeFMENJ0Xn5x2J0Ng7E9VjUxeixiuc2JbzxknC03z9Eh0n0p4XQ6667fr3Vgf9X5afyyza_HIQ-uTPbItmeIt802QY_JaXEbbUc_t2g01lqik9lLSx7mj3N53DVYh_VZxIkClNe3RpTn_TLcSIxbWjPVJA3DImnQDynzbZ2bIM59gppEczNB9hnPvjHo2M2d0K7M286_1l7IDUVvg" --interactive=false
        - name: Download Artifact
          run: |
            jf rt dl tf-trial/workspaces/jfrog-ws1/Jenkinsfile1
            jf rt bp

        

 deploy:
        name: Deploy
        needs: test
        runs-on: ubuntu-latest
        steps:     
            - name: ServiceNow DevOps Change Automation
            # You may pin to the exact commit or the version.
              uses: ServiceNow/servicenow-devops-change@dev
              with:
                  # ServiceNow Instance URL
                  instance-url: ${{ secrets.SN_INSTANCE_URL }}
                  # # # Devops Integration User Name
                  # devops-integration-user-name: ${{ secrets.SN_DEVOPS_USER }}
                  # # # Devops Integration User Password
                  # devops-integration-user-password: ${{ secrets.SN_DEVOPS_PASSWORD }}
                  # Devops Integration User Name
                  devops-integration-token: ${{ secrets.SN_INSTANCE_TOKEN }}
                  # Orchestration Tool Id
                  tool-id: ${{ secrets.SN_ORCHESTRATION_TOOL_ID }}
                  # Display Name of the Job
                  job-name: 'Deploy'
                  # Github Context
                  context-github: ${{ toJSON(github) }}
                  # The max. time in seconds to wait until the action should fail.
                  timeout: 3600
                  # The time in seconds to wait between trying the API.
                  interval: 5
                  # The customized inputs to create change with the requested details.
                  change-request: '{
                      "setCloseCode": "true",
                      "attributes": {
                          "short_description": "Automated Software Deployment",
                          "description": "Automated Software Deployment.",
                          "assignment_group": "a715cd759f2002002920bde8132e7018",
                          "implementation_plan": "Software update is tested and results can be found in Test Summaries Tab.",
                          "backout_plan": "When software fails in production, the previous software release will be re-deployed.",
                          "test_plan": "Testing if the software was successfully deployed"
                      }
                  }'

  
